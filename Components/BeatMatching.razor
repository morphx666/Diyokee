@using static Diyokee.Settings
@inject IJSRuntime JS

<Waveform CssColor="@player1?.Settings.Color"
          Mode="Waveform.Modes.AudioSynced"
          Player="player1"
          BpmAwareScale="true"
          EnableZoomControls="false"
          @ref="waveform1" />

<Waveform CssColor="@player2?.Settings.Color"
          Mode="Waveform.Modes.AudioSynced"
          Player="player2"
          BpmAwareScale="true"
          EnableZoomControls="false"
          @ref="waveform2" />

@code {
    [Parameter]
    public Player? player1 { get; set; } = default!;

    [Parameter]
    public Player? player2 { get; set; } = default!;

    private Waveform? waveform1;
    private Waveform? waveform2;

    [JSInvokable]
    public async Task OnResize() {
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if(firstRender) {
            int delay = 30;
            await OnResize();

            var dotNetReference = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("Diyokee.monitorResize", dotNetReference);

            await Task.Run(async () => {
                while(true) {
                    await Task.Delay(delay);

                    if(waveform1 != null && player1 != null) {
                        waveform1.PlaybackHead = player1.PlaybackHead;
                        await waveform1.Refresh();
                    }
                    if(waveform2 != null && player2 != null) {
                        waveform2.PlaybackHead = player2.PlaybackHead;
                        await waveform2.Refresh();
                    }
                }
            });
        }
        base.OnAfterRender(firstRender);
    }
}
