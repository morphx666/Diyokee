@using Un4seen.Bass

<ModalDialog Title="Settings"
             OnSave="Save"
             OnClose="Close"
             @ref="dialog">

    @if(settings == null) return;

    <div class="header">
        <h3>Audio</h3>
        <AudioMatrix Settings="settings" />
    </div>

    <div class="header">
        <h3>Media Providers</h3>
        <div class="media-providers scroller">
            @foreach(var provider in settings.MediaProviders) {
                <MediaProviderUI
                    Provider="provider"
                    OnDeleteProvider="@(() => DeleteProvider(provider))" />
            }
            <button class="button-add-provider" onclick="@AddProvider"><i class="fa-solid fa-circle-plus"></i></button>
        </div>
    </div>

    <div class="header">
        <h3>Playback</h3>

        <div class="field">
            <label for="lock-onplay">Lock players while playing</label>
            <InputCheckbox id="lock-onplay" @bind-value="settings.Playback.LockOnPlay" />
        </div>

        <div class="field">
            <label for="sync-playback">Start playback in-sync with other player </label>
            <InputCheckbox id="sync-playback" @bind-value="settings.Playback.SyncPlayback" />
            <span class="info" hidden="@(!settings.Playback.SyncPlayback)">(hold SHIFT to override)</span>
        </div>

        <div class="field">
            <label for="tempo-range">Tempo Range -/+</label>
            <div class="select-container">
                <InputSelect id="tempo-range" @bind-value="settings.Playback.TempoRange">
                    @foreach(var tempoRange in TempoRanges) {
                        <option value="@tempoRange">@tempoRange</option>
                    }
                </InputSelect>
            </div>
        </div>

        @*
            FIXME: This could be removed. It's already available as a dropdown menu for each player.
            Or perhaps we should remove the dropdown menus from the main UI?
        *@
        <div class="field">
            <label for="eq-profile">Equalizer Profile</label>
            <div class="select-container">
                <InputSelect id="eq-profile" @bind-value="settings.Playback.EqProfile">
                    @foreach(var profile in settings.EqualizerProfiles) {
                        <option value="@profile.Name">@profile.Name</option>
                    }
                </InputSelect>
            </div>
        </div>

        <div class="eq-profile-info">
            <span>Low:</span><span>@(settings.EqualizerProfiles.Where(p => p.Name == settings.Playback.EqProfile).First().Low.ToString("N2")) Hz</span>
            <span>Mid:</span><span>@(settings.EqualizerProfiles.Where(p => p.Name == settings.Playback.EqProfile).First().Mid.ToString("N2")) Hz</span>
            <span>Hi:</span><span>@(settings.EqualizerProfiles.Where(p => p.Name == settings.Playback.EqProfile).First().Hi.ToString("N2")) Hz</span>
        </div>

        @foreach(var playerObj in settings.Playback.Players.Select((player, index) => new { player, index })) {
            <div class="sub-header">
                <h5>Player @(playerObj.index + 1)</h5>

                <div class="field">
                    <label for="@($"player{playerObj.index}-name")">Name</label>
                    <InputText id="@($"player{playerObj.index}-name")" @bind-value="playerObj.player.Name" />
                </div>
                <div class="field">
                    <label for="@($"player{playerObj.index}-color")">Color</label>
                    <InputText class="as-number"
                               id="@($"player{playerObj.index}-color")"
                               @bind-value="playerObj.player.Color" />
                    <div class="color" style="background-color: @(playerObj.player.Color)"></div>
                </div>
                <div class="field">
                    <label for="@($"player{playerObj.index}-reverse-controls")">Reverse Controls Order</label>
                    <InputCheckbox id="@($"player{playerObj.index}-reverse-controls")" @bind-value="playerObj.player.ReverseControls" />
                </div>
            </div>
        }

        <div class="header">
            <h3>Midi</h3>
            <MidiControllersUI
                Settings="settings"
                MidiProfiles="midiProfiles"/>
        </div>
    </div>
</ModalDialog>

@code {
    private ModalDialog dialog = null!;

    [Parameter]
    public EventCallback OnSave { get; set; } = default!;

    [Parameter]
    public EventCallback OnClose { get; set; } = default!;

    private Settings settings = default!;
    private List<MidiControllerProfile> midiProfiles = default!;

    private static readonly int[] TempoRanges = new int[] { 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 25, 35, 50, 100 };

    public void Open() {
        settings = (Settings)Program.Settings.Clone();
        midiProfiles = Program.MidiControllersProfiles.Select(p => (MidiControllerProfile)p.Clone()).ToList();
        dialog.Open();
    }

    public void Close() {
        dialog.Close();

        OnClose.InvokeAsync();
    }

    public async void Save() {
        foreach(var mp in Program.MidiControllersProfiles) {
            File.Delete(MidiControllerProfile.GetProfilePath(mp.Name));
        }

        Program.Settings = settings;
        Program.MidiControllersProfiles = midiProfiles;
        await Program.Settings.Save();
        await MidiControllerProfile.SaveAll(Program.MidiControllersProfiles);
        Close();

        await OnSave.InvokeAsync();
    }

    private void DeleteProvider(Settings.MediaProvider provider) {
        settings.MediaProviders.Remove(provider);
    }

    private void AddProvider() {
        var newProvider = new Settings.MediaProvider();
        newProvider.Type = "local";
        newProvider.Name = "New Local Provider";
        newProvider.RootDirectory = Environment.GetFolderPath(Environment.SpecialFolder.MyMusic);
        settings.MediaProviders.Add(newProvider);
    }
}